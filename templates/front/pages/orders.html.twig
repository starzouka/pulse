{% extends 'base.html.twig' %}

{% block title %}PULSE - Mes commandes{% endblock %}

{% block body %}
  {% include 'front/partials/_hero_mini.html.twig' with {
    hero_kicker: 'JOUEUR',
    hero_title: 'Mes commandes',
    hero_sub: 'Historique, statuts et acces detail commande.',
    breadcrumb_current: 'Mes commandes'
  } %}

  <main class="page">
    <section class="belowHero">
      <div class="layout">
        {% include 'front/partials/_player_side_nav.html.twig' with { active: 'orders' } %}

        <div class="socialShell">
          <div class="socialStack">
            <section class="panel">
              <form class="filtersRow" method="get" action="{{ path('front_orders') }}" data-auto-submit="1">
                <input class="input" type="search" name="q" value="{{ filters.q|default('') }}" placeholder="Numero, adresse, paiement..." />
                <div class="select">
                  <select name="status">
                    <option value="" {{ filters.status is empty ? 'selected' : '' }}>Tous statuts</option>
                    <option value="PENDING" {{ filters.status == 'PENDING' ? 'selected' : '' }}>PENDING</option>
                    <option value="PAID" {{ filters.status == 'PAID' ? 'selected' : '' }}>PAID</option>
                    <option value="CANCELLED" {{ filters.status == 'CANCELLED' ? 'selected' : '' }}>CANCELLED</option>
                    <option value="SHIPPED" {{ filters.status == 'SHIPPED' ? 'selected' : '' }}>SHIPPED</option>
                    <option value="DELIVERED" {{ filters.status == 'DELIVERED' ? 'selected' : '' }}>DELIVERED</option>
                  </select>
                </div>
                <input class="input" type="date" name="from" value="{{ filters.from|default('') }}" />
                <input class="input" type="date" name="to" value="{{ filters.to|default('') }}" />
                <div class="select">
                  <select name="sort">
                    <option value="latest" {{ (filters.sort|default('latest')) == 'latest' ? 'selected' : '' }}>Plus recentes</option>
                    <option value="oldest" {{ (filters.sort|default('latest')) == 'oldest' ? 'selected' : '' }}>Plus anciennes</option>
                    <option value="amount_high" {{ (filters.sort|default('latest')) == 'amount_high' ? 'selected' : '' }}>Montant DESC</option>
                    <option value="amount_low" {{ (filters.sort|default('latest')) == 'amount_low' ? 'selected' : '' }}>Montant ASC</option>
                    <option value="status" {{ (filters.sort|default('latest')) == 'status' ? 'selected' : '' }}>Statut</option>
                  </select>
                </div>
                <button class="btn btn--ghost" type="submit">Filtrer</button>
                <a class="btn btn--ghost" href="{{ path('front_orders') }}">Reset</a>
              </form>
            </section>

            <section class="panel">
              {% if orders is empty %}
                <div class="emptyState">Aucune commande pour ces filtres.</div>
              {% else %}
                <div class="tableWrap">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Commande</th>
                        <th>Date</th>
                        <th>Total</th>
                        <th>Paiement</th>
                        <th>Statut</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for order in orders %}
                        {% set orderId = order.orderId ?? 0 %}
                        {% set status = order.status|default('PENDING') %}
                        {% set statusClass = status == 'PAID' or status == 'DELIVERED' ? 'badge--success' : (status == 'SHIPPED' ? 'badge--warning' : (status == 'CANCELLED' ? 'badge--danger' : '')) %}
                        <tr>
                          <td>{{ order.orderNumber }}</td>
                          <td>{{ order.createdAt ? order.createdAt|date('d/m/Y') : '-' }}</td>
                          <td>{{ order.totalAmount|number_format(2, '.', ' ') }} DT</td>
                          <td>{{ order.paymentStatus ?? '-' }}</td>
                          <td><span class="badge {{ statusClass }}">{{ status }}</span></td>
                          <td>
                            {% if orderId > 0 %}
                              <a class="btn btn--ghost" href="{{ path('front_order_detail', {id: orderId}) }}">Detail</a>
                            {% else %}
                              <a class="btn btn--ghost" href="{{ path('front_order_detail') }}">Detail</a>
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}
            </section>

            {% include 'front/partials/_pagination.html.twig' with {
              pagination: pagination,
              route_name: 'front_orders'
            } %}
          </div>

          <aside class="socialStack">
            <section class="panel">
              <h3 class="panel__title">RESUME COMMANDES</h3>
              <div class="statsRow">
                <div class="statCard"><div class="statCard__value">{{ summary.total|default(0) }}</div><div class="statCard__label">Totales</div></div>
                <div class="statCard"><div class="statCard__value">{{ summary.shipping|default(0) }}</div><div class="statCard__label">En livraison</div></div>
                <div class="statCard"><div class="statCard__value">{{ summary.pending|default(0) }}</div><div class="statCard__label">En attente</div></div>
              </div>
            </section>

            <section class="panel">
              <h3 class="panel__title">RACCOURCIS</h3>
              <div class="socialQuickList">
                <a class="listItem" href="{{ path('front_cart') }}"><span>Ouvrir panier</span><span class="listItem__meta">Panier</span></a>
                <a class="listItem" href="{{ path('front_shop') }}"><span>Retour boutique</span><span class="listItem__meta">Explorer</span></a>
                <a class="listItem" href="{{ path('front_notifications') }}"><span>Notifications</span><span class="listItem__meta">Alertes</span></a>
              </div>
            </section>
          </aside>
        </div>
      </div>

      {% include 'front/partials/_footer.html.twig' %}
    </section>
  </main>

  {% include 'front/partials/_auth_modal.html.twig' %}
{% endblock %}
