{% extends 'base.html.twig' %}

{% block title %}PULSE - Modifier produit{% endblock %}

{% block body %}
  {% include 'front/partials/_hero_mini.html.twig' with {
    hero_kicker: 'CAPITAINE',
    hero_title: 'Modifier produit',
    hero_sub: 'Mise a jour complete du produit selectionne.',
    breadcrumb_current: 'Modifier produit'
  } %}

  <main class="page">
    <section class="belowHero">
      <div class="layout">
        {% include 'front/partials/_captain_side_nav.html.twig' with {
          active: 'products',
          active_team: active_team
        } %}

        <div>
          {% include 'front/partials/_captain_team_selector.html.twig' with {
            captain_teams: captain_teams,
            active_team: active_team,
            selector_route: 'front_captain_product_edit'
          } %}

          <form class="panel" method="post" action="{{ path('front_captain_product_edit', {id: product.productId, team: active_team.teamId}) }}" enctype="multipart/form-data">
            <div class="panel__head">
              <div>
                <h3 class="panel__title">PRODUIT #{{ product.productId }}</h3>
                <div class="panel__desc">Champs: name, description, price, stock, sku, status.</div>
              </div>
            </div>

            <div class="formGrid" style="margin-top:12px;">
              <label class="field">
                <span class="field__label">Nom *</span>
                <input class="input" type="text" name="name" value="{{ product.name }}" required maxlength="150">
              </label>

              <label class="field">
                <span class="field__label">Prix (DT) *</span>
                <input class="input" type="number" name="price" min="0" step="0.01" value="{{ product.price }}" required>
              </label>

              <label class="field">
                <span class="field__label">Stock *</span>
                <input class="input" type="number" name="stock_qty" min="0" step="1" value="{{ product.stockQty }}" required>
              </label>

              <label class="field">
                <span class="field__label">SKU</span>
                <input class="input" type="text" name="sku" value="{{ product.sku }}" maxlength="64">
              </label>

              <label class="field">
                <span class="field__label">Statut</span>
                <select class="input" name="is_active">
                  <option value="1" {{ product.isActive ? 'selected' : '' }}>Actif</option>
                  <option value="0" {{ not product.isActive ? 'selected' : '' }}>Inactif</option>
                </select>
              </label>

              <label class="field">
                <span class="field__label">Description</span>
                <textarea class="textarea" name="description" rows="5">{{ product.description }}</textarea>
              </label>

              <label class="field">
                <span class="field__label">Ajouter des images</span>
                <input class="input" type="file" name="images[]" accept="image/png,image/jpeg,image/webp,image/gif" multiple>
              </label>
            </div>

            <div class="formActions" style="margin-top:12px;">
              <input type="hidden" name="_token" value="{{ csrf_token('captain_product_edit_' ~ product.productId) }}">
              <input type="hidden" name="team_id" value="{{ active_team.teamId }}">
              <button class="btn btn--primary" type="submit">Mettre a jour</button>
              <a class="btn btn--ghost" href="{{ path('front_captain_products', {team: active_team.teamId}) }}">Retour liste</a>
            </div>
          </form>

          <section class="panel">
            <h3 class="panel__title">IMAGES ACTUELLES</h3>
            <div class="cardsGrid" style="margin-top:10px;">
              {% for image in product_images %}
                {% set imagePath = image.fileUrl ?: '' %}
                {% set imageUrl = imagePath ? (imagePath starts with 'http' ? imagePath : asset(imagePath)) : 'https://picsum.photos/seed/product_image_' ~ image.imageId ~ '/900/700' %}
                <article class="card">
                  <div class="card__media" data-bg="{{ imageUrl }}"></div>
                  <div class="card__body">
                    <div class="card__metaRow">
                      <span class="metaPill">Image #{{ image.imageId }}</span>
                    </div>
                    <form method="post" action="{{ path('front_captain_product_image_remove', {id: product.productId, imageId: image.imageId}) }}">
                      <input type="hidden" name="_token" value="{{ csrf_token('captain_product_remove_image_' ~ product.productId ~ '_' ~ image.imageId) }}">
                      <input type="hidden" name="team_id" value="{{ active_team.teamId }}">
                      <button class="btn btn--ghost" type="submit">Retirer image</button>
                    </form>
                  </div>
                </article>
              {% else %}
                <div class="emptyState">Aucune image associee.</div>
              {% endfor %}
            </div>
          </section>
        </div>
      </div>

      {% include 'front/partials/_footer.html.twig' %}
    </section>
  </main>

  {% include 'front/partials/_auth_modal.html.twig' %}
{% endblock %}

