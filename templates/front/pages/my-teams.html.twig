{% extends 'base.html.twig' %}

{% block title %}PULSE - Mes equipes{% endblock %}

{% block body %}
  {% include 'front/partials/_hero_mini.html.twig' with {
    hero_kicker: 'JOUEUR',
    hero_title: 'Mes equipes',
    hero_sub: 'Vue sociale des equipes rejointes et des invitations.',
    breadcrumb_current: 'Mes equipes'
  } %}

  <main class="page">
    <section class="belowHero">
      <div class="layout">
        {% include 'front/partials/_player_side_nav.html.twig' with { active: 'my_teams' } %}

        <div class="socialShell">
          <div class="socialStack">
            {% for label, messages in app.flashes %}
              {% for message in messages %}
                <div class="listItem">
                  <span>{{ message }}</span>
                  <span class="badge {{ label == 'error' ? 'badge--danger' : (label == 'info' ? 'badge--info' : 'badge--success') }}">{{ label|upper }}</span>
                </div>
              {% endfor %}
            {% endfor %}

            <section class="panel">
              <div class="panel__head">
                <h3 class="panel__title">EQUIPES ACTIVES</h3>
                <a class="btn btn--ghost" href="{{ path('front_teams_explore') }}">Explorer</a>
              </div>

              <form class="filtersRow" method="get" action="{{ path('front_my_teams') }}" style="margin-bottom:12px;" data-auto-submit="1">
                <input class="input" type="search" name="teams_q" value="{{ filters.teams_q|default('') }}" placeholder="Rechercher une equipe..." />
                <input class="input" type="text" name="teams_region" value="{{ filters.teams_region|default('') }}" placeholder="Region" />
                <div class="select">
                  <select name="teams_sort">
                    <option value="latest" {{ (filters.teams_sort|default('latest')) == 'latest' ? 'selected' : '' }}>Rejoint recemment</option>
                    <option value="oldest" {{ (filters.teams_sort|default('latest')) == 'oldest' ? 'selected' : '' }}>Rejoint anciennement</option>
                    <option value="name" {{ (filters.teams_sort|default('latest')) == 'name' ? 'selected' : '' }}>Nom A-Z</option>
                    <option value="region" {{ (filters.teams_sort|default('latest')) == 'region' ? 'selected' : '' }}>Region</option>
                  </select>
                </div>
                <button class="btn btn--ghost" type="submit">Filtrer</button>
              </form>

              {% if active_team_members is empty %}
                <div class="emptyState">Vous n'avez aucune equipe active.</div>
              {% else %}
                {% for membership in active_team_members %}
                  {% set team = membership.teamId %}
                  {% set teamId = team ? (team.teamId ?? 0) : 0 %}
                  {% set captain = team ? team.captainUserId : null %}
                  {% set logoPath = team and team.logoImageId ? team.logoImageId.fileUrl : '' %}
                  {% set logoUrl = logoPath ? (logoPath starts with 'http' ? logoPath : asset(logoPath)) : 'https://picsum.photos/seed/pulse_team_' ~ teamId ~ '/200/200' %}

                  <article class="panel">
                    <div class="postCard__head">
                      <div class="postCard__author">
                        <div class="avatarMd" data-avatar="{{ logoUrl }}"></div>
                        <div>
                          <div class="name">{{ team ? team.name : 'Equipe' }}</div>
                          <div class="sub">
                            Role: {{ team and captain and viewer_user and captain.userId == viewer_user.userId ? 'Capitaine' : 'Membre' }}
                            {% if team and team.region %} · {{ team.region }}{% endif %}
                          </div>
                          <div class="sub">Rejoint le {{ membership.joinedAt ? membership.joinedAt|date('d/m/Y') : '-' }}</div>
                        </div>
                      </div>
                      <span class="badge badge--success">ACTIVE</span>
                    </div>
                    <div class="postCard__actions">
                      <a class="btn btn--ghost" href="{{ path('front_team_detail') }}">Voir equipe</a>
                      {% if teamId > 0 %}
                        <form method="post" action="{{ path('front_my_teams_leave', {teamId: teamId}) }}">
                          <input type="hidden" name="_token" value="{{ csrf_token('team_leave_' ~ teamId) }}">
                          <button class="btn btn--ghost" type="submit">Quitter</button>
                        </form>
                      {% endif %}
                    </div>
                  </article>
                {% endfor %}
              {% endif %}
            </section>

            {% include 'front/partials/_pagination.html.twig' with {
              pagination: pagination.teams|default(null),
              route_name: 'front_my_teams',
              page_param: 'teams_page'
            } %}
          </div>

          <aside class="socialStack">
            <section class="panel">
              <h3 class="panel__title">INVITATIONS</h3>
              <form class="filtersRow" method="get" action="{{ path('front_my_teams') }}" style="margin-bottom:12px;" data-auto-submit="1">
                <input type="hidden" name="teams_q" value="{{ filters.teams_q|default('') }}">
                <input type="hidden" name="teams_region" value="{{ filters.teams_region|default('') }}">
                <input type="hidden" name="teams_sort" value="{{ filters.teams_sort|default('latest') }}">
                <input class="input" type="search" name="invites_q" value="{{ filters.invites_q|default('') }}" placeholder="Rechercher une invitation..." />
                <div class="select">
                  <select name="invites_status">
                    <option value="" {{ (filters.invites_status|default('PENDING')) == '' ? 'selected' : '' }}>Tous statuts</option>
                    <option value="PENDING" {{ (filters.invites_status|default('PENDING')) == 'PENDING' ? 'selected' : '' }}>PENDING</option>
                    <option value="ACCEPTED" {{ (filters.invites_status|default('PENDING')) == 'ACCEPTED' ? 'selected' : '' }}>ACCEPTED</option>
                    <option value="REFUSED" {{ (filters.invites_status|default('PENDING')) == 'REFUSED' ? 'selected' : '' }}>REFUSED</option>
                    <option value="CANCELLED" {{ (filters.invites_status|default('PENDING')) == 'CANCELLED' ? 'selected' : '' }}>CANCELLED</option>
                  </select>
                </div>
                <div class="select">
                  <select name="invites_sort">
                    <option value="latest" {{ (filters.invites_sort|default('latest')) == 'latest' ? 'selected' : '' }}>Plus recentes</option>
                    <option value="oldest" {{ (filters.invites_sort|default('latest')) == 'oldest' ? 'selected' : '' }}>Plus anciennes</option>
                    <option value="team" {{ (filters.invites_sort|default('latest')) == 'team' ? 'selected' : '' }}>Equipe</option>
                    <option value="status" {{ (filters.invites_sort|default('latest')) == 'status' ? 'selected' : '' }}>Statut</option>
                  </select>
                </div>
                <button class="btn btn--ghost" type="submit">Filtrer</button>
                <a class="btn btn--ghost" href="{{ path('front_my_teams') }}">Reset</a>
              </form>

              {% if pending_team_invites is empty %}
                <div class="emptyState">Aucune invitation avec ces filtres.</div>
              {% else %}
                <div class="socialQuickList">
                  {% for invite in pending_team_invites %}
                    {% set inviteId = invite.inviteId ?? 0 %}
                    {% set team = invite.teamId %}
                    {% set invitedBy = invite.invitedByUserId %}

                    <article class="listItem">
                      <span>
                        {{ team ? team.name : 'Equipe' }}
                        {% if invitedBy %} - invite par {{ invitedBy.displayName ?? invitedBy.username }}{% endif %}
                      </span>
                      <span class="badge">{{ invite.status }}</span>
                    </article>

                    {% if invite.message %}
                      <div class="listItem__meta">{{ invite.message }}</div>
                    {% endif %}

                    {% if inviteId > 0 %}
                      <div class="postCard__actions" style="margin-top:10px;">
                        <form method="post" action="{{ path('front_my_teams_invite_respond', {id: inviteId}) }}">
                          <input type="hidden" name="_token" value="{{ csrf_token('team_invite_respond_' ~ inviteId) }}">
                          <input type="hidden" name="decision" value="ACCEPTED">
                          <button class="btn btn--primary" type="submit">Accepter</button>
                        </form>
                        <form method="post" action="{{ path('front_my_teams_invite_respond', {id: inviteId}) }}">
                          <input type="hidden" name="_token" value="{{ csrf_token('team_invite_respond_' ~ inviteId) }}">
                          <input type="hidden" name="decision" value="REFUSED">
                          <button class="btn btn--ghost" type="submit">Refuser</button>
                        </form>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            </section>

            {% include 'front/partials/_pagination.html.twig' with {
              pagination: pagination.invites|default(null),
              route_name: 'front_my_teams',
              page_param: 'invites_page'
            } %}

            <section class="panel">
              <h3 class="panel__title">RACCOURCIS</h3>
              <div class="socialQuickList">
                <a class="listItem" href="{{ path('front_my_requests') }}"><span>Mes demandes</span><span class="listItem__meta">Suivi</span></a>
                <a class="listItem" href="{{ path('front_teams_explore') }}"><span>Trouver une equipe</span><span class="listItem__meta">Explorer</span></a>
                <a class="listItem" href="{{ path('front_tournaments') }}"><span>Tournois ouverts</span><span class="listItem__meta">Voir</span></a>
              </div>
            </section>

            <section class="panel">
              <h3 class="panel__title">RESUME</h3>
              <div class="statsRow">
                <div class="statCard"><div class="statCard__value">{{ pagination.teams.total_items|default(active_team_members|length) }}</div><div class="statCard__label">Equipes actives</div></div>
                <div class="statCard"><div class="statCard__value">{{ pagination.invites.total_items|default(pending_team_invites|length) }}</div><div class="statCard__label">Invitations</div></div>
              </div>
            </section>
          </aside>
        </div>
      </div>

      {% include 'front/partials/_footer.html.twig' %}
    </section>
  </main>

  {% include 'front/partials/_auth_modal.html.twig' %}
{% endblock %}
