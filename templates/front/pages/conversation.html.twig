{% extends 'base.html.twig' %}

{% block title %}PULSE - Conversation{% endblock %}

{% block body %}
  {% include 'front/partials/_hero_mini.html.twig' with {
    hero_kicker: 'JOUEUR',
    hero_title: 'Conversation',
    hero_sub: 'Discussion privee en temps reel.',
    breadcrumb_current: 'Conversation'
  } %}

  <main class="page">
    <section class="belowHero">
      <div class="layout">
        {% include 'front/partials/_player_side_nav.html.twig' with { active: 'conversation' } %}

        <div class="socialShell--chat">
          <aside class="socialStack">
            <section class="panel gadget">
              <h3 class="panel__title">CONVERSATIONS</h3>
              <div class="socialQuickList">
                {% for conversation in conversations %}
                  {% set partner = conversation.partner %}
                  {% set partnerId = partner.userId ?? 0 %}
                  {% set active = selected_partner and selected_partner.userId == partnerId %}
                  <a class="listItem {{ active ? 'is-active' : '' }}" href="{{ path('front_conversation', {id: partnerId}) }}">
                    <span>{{ partner.displayName ?? partner.username }}</span>
                    {% if conversation.unread_count > 0 %}
                      <span class="badge">{{ conversation.unread_count }}</span>
                    {% elseif conversation.latest_message %}
                      <span class="listItem__meta">{{ conversation.latest_message.createdAt ? conversation.latest_message.createdAt|date('d/m H:i') : '' }}</span>
                    {% else %}
                      <span class="listItem__meta">-</span>
                    {% endif %}
                  </a>
                {% else %}
                  <div class="emptyState">Aucune conversation disponible.</div>
                {% endfor %}
              </div>
            </section>
          </aside>

          <div class="socialStack">
            <section class="panel gadget">
              {% if selected_partner %}
                {% set partnerId = selected_partner.userId ?? 0 %}
                <div class="panel__head">
                  <div>
                    <h3 class="panel__title">CHAT AVEC {{ selected_partner.displayName ?? selected_partner.username }}</h3>
                    <div class="panel__desc">Messages les plus recents</div>
                  </div>
                  <a class="btn btn--ghost" href="{{ path('front_player_profile', {id: partnerId}) }}">Voir profil</a>
                </div>

                <div class="list" style="max-height: 420px; overflow:auto;">
                  {% for message in messages %}
                    {% set mine = viewer_user and message.senderUserId and message.senderUserId.userId == viewer_user.userId %}
                    <div class="listItem {{ mine ? 'is-mine' : '' }}">
                      <span>
                        <b>{{ mine ? 'Moi' : (message.senderUserId ? (message.senderUserId.displayName ?? message.senderUserId.username) : 'User') }}:</b>
                        {{ message.bodyText }}
                      </span>
                      <span class="listItem__meta">{{ message.createdAt ? message.createdAt|date('d/m H:i') : '' }}</span>
                    </div>
                  {% else %}
                    <div class="emptyState">Aucun message.</div>
                  {% endfor %}
                </div>

                <form method="post" action="{{ path('front_conversation', {id: partnerId}) }}" style="margin-top:10px; display:flex; gap:8px; align-items:flex-start;">
                  <input type="hidden" name="_token" value="{{ csrf_token('conversation_send') }}">
                  <textarea class="textarea" name="body_text" placeholder="Ecrire un message..." style="min-height: 70px; flex:1;" required></textarea>
                  <button class="btn btn--primary" type="submit">Envoyer</button>
                </form>
              {% else %}
                <div class="emptyState">Aucun destinataire selectionne.</div>
              {% endif %}
            </section>
          </div>
        </div>
      </div>

      {% include 'front/partials/_footer.html.twig' %}
    </section>
  </main>

  {% include 'front/partials/_auth_modal.html.twig' %}
{% endblock %}
