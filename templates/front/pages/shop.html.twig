{% extends 'base.html.twig' %}

{% block title %}PULSE - Boutique{% endblock %}

{% block body %}
  {% include 'front/partials/_hero_mini.html.twig' with {
    hero_kicker: 'BOUTIQUE',
    hero_title: 'Boutique',
    hero_sub: 'Catalogue des produits vendus par les equipes.',
    breadcrumb_current: 'Boutique'
  } %}

  <main class="page">
    <section class="belowHero">
      {% for label, messages in app.flashes %}
        {% for message in messages %}
          <div class="listItem">
            <span>{{ message }}</span>
            <span class="badge {{ label == 'error' ? 'badge--danger' : (label == 'info' ? 'badge--info' : 'badge--success') }}">{{ label|upper }}</span>
          </div>
        {% endfor %}
      {% endfor %}

      <div class="pageHeader">
        <div>
          <h1>Boutique</h1>
          <p>Recherche backend sur la base de donnees: nom, equipe, prix, stock.</p>
        </div>
        <div class="pageHeader__actions">
          <a class="btn btn--ghost" href="{{ path('front_cart') }}">Panier ({{ cart_items_count|default(0) }})</a>
          <a class="btn btn--ghost" href="{{ path('front_orders') }}">Mes commandes</a>
        </div>
      </div>

      <section class="panel">
        <form class="filtersRow" method="get" action="{{ path('front_shop') }}">
          <input class="input" type="search" name="q" value="{{ filters.q|default('') }}" placeholder="Rechercher un produit..." />

          <div class="select">
            <select name="team">
              <option value="">Toutes les equipes</option>
              {% for team in teams %}
                <option value="{{ team.teamId }}" {{ filters.team == team.teamId ? 'selected' : '' }}>{{ team.name }}</option>
              {% endfor %}
            </select>
          </div>

          <input class="input" type="number" step="0.01" min="0" name="min" value="{{ filters.min|default('') }}" placeholder="Prix min" />
          <input class="input" type="number" step="0.01" min="0" name="max" value="{{ filters.max|default('') }}" placeholder="Prix max" />

          <label class="btn btn--ghost" style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" name="stock" value="1" {{ filters.stock ? 'checked' : '' }} />
            En stock
          </label>

          <button class="btn btn--primary" type="submit">Filtrer</button>
          <a class="btn btn--ghost" href="{{ path('front_shop') }}">Reset</a>
        </form>
      </section>

      <section class="cardsGrid">
        {% if products is empty %}
          <div class="panel emptyState" style="grid-column: 1 / -1;">
            Aucun produit ne correspond aux filtres.
          </div>
        {% else %}
          {% for product in products %}
            {% set productId = product.productId ?? 0 %}
            {% set primaryImage = product_primary_images[productId]|default(null) %}
            {% set imagePath = primaryImage ? primaryImage.fileUrl : '' %}
            {% set imageUrl = imagePath ? (imagePath starts with 'http' ? imagePath : asset(imagePath)) : 'https://picsum.photos/seed/pulse_shop_' ~ productId ~ '/1200/800' %}

            <article class="card card--product">
              <div class="card__media" data-bg="{{ imageUrl }}">
                <div class="card__chips">
                  <span class="chip chip--price">{{ product.price|number_format(2, '.', ' ') }} DT</span>
                  <span class="chip">Stock: {{ product.stockQty }}</span>
                  <span class="chip">{{ product.teamId ? product.teamId.name : 'Equipe' }}</span>
                </div>
              </div>

              <div class="card__body">
                <h4 class="card__title">{{ product.name }}</h4>
                <p class="card__desc">{{ product.description ? product.description|slice(0, 90) ~ (product.description|length > 90 ? '...' : '') : 'Produit equipe PULSE.' }}</p>

                <div class="card__actions">
                  {% if productId > 0 %}
                    <a class="btn btn--ghost" href="{{ path('front_product_detail', {id: productId}) }}">Detail</a>
                  {% else %}
                    <a class="btn btn--ghost" href="{{ path('front_product_detail') }}">Detail</a>
                  {% endif %}

                  {% if app.user %}
                    <form method="post" action="{{ path('front_cart_add', {id: productId}) }}">
                      <input type="hidden" name="_token" value="{{ csrf_token('cart_add_' ~ productId) }}">
                      <input type="hidden" name="quantity" value="1">
                      <button class="btn btn--primary" type="submit" {{ product.stockQty <= 0 ? 'disabled' : '' }}>
                        {{ product.stockQty <= 0 ? 'Rupture' : 'Ajouter au panier' }}
                      </button>
                    </form>
                  {% else %}
                    <a class="btn btn--primary" href="{{ path('front_login', {'_target_path': app.request.uri}) }}">Ajouter au panier</a>
                  {% endif %}
                </div>
              </div>
            </article>
          {% endfor %}
        {% endif %}
      </section>

      {% include 'front/partials/_footer.html.twig' %}
    </section>
  </main>

  {% include 'front/partials/_auth_modal.html.twig' %}
{% endblock %}
