{% extends 'base.html.twig' %}

{% block title %}PULSE - Mes demandes{% endblock %}

{% block body %}
  {% include 'front/partials/_hero_mini.html.twig' with {
    hero_kicker: 'ORGANISATEUR',
    hero_title: 'Mes demandes',
    hero_sub: 'Suivi detaille des demandes de tournoi envoyees.',
    breadcrumb_current: 'Mes demandes'
  } %}

  <main class="page">
    <section class="belowHero">
      <div class="layout">
        {% include 'front/partials/_organizer_side_nav.html.twig' with {active: 'requests'} %}

        <div>
          {% for label, messages in app.flashes %}
            {% for message in messages %}
              <div class="listItem">
                <span>{{ message }}</span>
                <span class="badge {{ label == 'error' ? 'badge--danger' : 'badge--success' }}">{{ label|upper }}</span>
              </div>
            {% endfor %}
          {% endfor %}

          <div class="panel">
            <div class="panel__head">
              <h3 class="panel__title">DEMANDES ENVOYEES</h3>
              <div class="panel__actions">
                <span class="panel__desc">Total: {{ counter|default(tournamentRequests|length) }} demande(s)</span>
                <a class="btn btn--ghost" href="{{ path('front_organizer_requests_export', {
                  format: 'pdf',
                  q: filters.q|default(''),
                  status: filters.status|default(''),
                  game: filters.game|default(''),
                  sort: filters.sort|default('latest')
                }) }}">PDF</a>
                <a class="btn btn--ghost" href="{{ path('front_organizer_requests_export', {
                  format: 'excel',
                  q: filters.q|default(''),
                  status: filters.status|default(''),
                  game: filters.game|default(''),
                  sort: filters.sort|default('latest')
                }) }}">Excel</a>
                <a class="btn btn--primary" href="{{ path('front_organizer_request_create') }}">Nouvelle demande</a>
              </div>
            </div>

            <form method="get" action="{{ path('front_organizer_requests') }}">
              <div class="filtersRow">
                <input class="input" type="search" name="q" value="{{ filters.q|default('') }}" placeholder="Rechercher une demande..." />

                <div class="select">
                  <select name="status">
                    <option value="">Statut</option>
                    {% for statusValue in statusOptions %}
                      <option value="{{ statusValue }}" {{ filters.status == statusValue ? 'selected' : '' }}>{{ statusValue }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="select">
                  <select name="game">
                    <option value="">Jeu</option>
                    {% for game in availableGames %}
                      <option value="{{ game.gameId }}" {{ filters.game is not null and filters.game == game.gameId ? 'selected' : '' }}>{{ game.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="select">
                  <select name="sort">
                    {% for sortValue in sortOptions %}
                      <option value="{{ sortValue }}" {{ filters.sort == sortValue ? 'selected' : '' }}>{{ sortValue|upper }}</option>
                    {% endfor %}
                  </select>
                </div>

                <button class="btn btn--primary" type="submit">Filtrer</button>
                <a class="btn btn--ghost" href="{{ path('front_organizer_requests') }}">Reset</a>
              </div>
            </form>

            <div class="tableWrap">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Titre</th>
                    <th>Jeu</th>
                    <th>Periode</th>
                    <th>Statut</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for requestItem in tournamentRequests %}
                    {% set statusClass = requestItem.status == 'ACCEPTED'
                      ? 'badge--success'
                      : (requestItem.status == 'REFUSED' ? 'badge--danger' : (requestItem.status == 'CANCELLED' ? 'badge--muted' : ''))
                    %}
                    <tr>
                      <td>#{{ requestItem.requestId }}</td>
                      <td>{{ requestItem.title }}</td>
                      <td>{{ requestItem.gameId ? requestItem.gameId.name : '-' }}</td>
                      <td>
                        {{ requestItem.startDate ? requestItem.startDate|date('Y-m-d') : '-' }}
                        -
                        {{ requestItem.endDate ? requestItem.endDate|date('Y-m-d') : '-' }}
                      </td>
                      <td><span class="badge {{ statusClass }}">{{ requestItem.status }}</span></td>
                      <td>
                        <a class="btn btn--ghost" href="{{ path('front_organizer_request_detail', {id: requestItem.requestId}) }}">Voir</a>
                      </td>
                    </tr>
                  {% else %}
                    <tr>
                      <td colspan="6" class="muted">Aucune demande pour le moment.</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="panel">
            <div class="panel__head">
              <div>
                <h3 class="panel__title">TABLES UTILISEES</h3>
                <div class="panel__desc">Donnees extraites depuis le schema reel.</div>
              </div>
            </div>
            <div class="list">
              <div class="listItem">
                <span><b>tournament_requests</b></span>
                <span class="listItem__meta">request_id, organizer_user_id, game_id, title, status, reviewed_at</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {% include 'front/partials/_footer.html.twig' %}
    </section>
  </main>

  {% include 'front/partials/_auth_modal.html.twig' %}
{% endblock %}
