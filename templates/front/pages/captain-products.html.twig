{% extends 'base.html.twig' %}

{% block title %}PULSE - Produits equipe{% endblock %}

{% block body %}
  {% include 'front/partials/_hero_mini.html.twig' with {
    hero_kicker: 'CAPITAINE',
    hero_title: 'Produits',
    hero_sub: "Gestion des produits de l'equipe active.",
    breadcrumb_current: 'Produits'
  } %}

  <main class="page">
    <section class="belowHero">
      <div class="layout">
        {% include 'front/partials/_captain_side_nav.html.twig' with {
          active: 'products',
          active_team: active_team
        } %}

        <div>
          {% include 'front/partials/_captain_team_selector.html.twig' with {
            captain_teams: captain_teams,
            active_team: active_team,
            selector_route: 'front_captain_products'
          } %}

          <form class="panel" method="get" action="{{ path('front_captain_products') }}">
            <div class="filtersRow">
              <input type="hidden" name="team" value="{{ active_team.teamId }}">
              <input class="input" type="search" name="q" value="{{ filters.q }}" placeholder="Rechercher nom, description ou SKU">
              <label class="field" style="display:flex;align-items:center;gap:8px;">
                <input type="checkbox" name="inactive" value="1" {{ filters.inactive ? 'checked' : '' }}>
                <span class="field__label">Inclure inactifs</span>
              </label>
              <button class="btn btn--ghost" type="submit">Filtrer</button>
              <a class="btn btn--primary" href="{{ path('front_captain_product_create', {team: active_team.teamId}) }}">Nouveau produit</a>
            </div>
          </form>

          <section class="panel">
            <div class="panel__head">
              <div>
                <h3 class="panel__title">PRODUITS DE {{ active_team.name|upper }}</h3>
                <div class="panel__desc">{{ products|length }} produit(s)</div>
              </div>
            </div>

            <div class="cardsGrid" style="margin-top:10px;">
              {% for product in products %}
                {% set primaryImage = product_primary_images[product.productId] ?? null %}
                {% set imagePath = primaryImage ? primaryImage.fileUrl : '' %}
                {% set imageUrl = imagePath ? (imagePath starts with 'http' ? imagePath : asset(imagePath)) : 'https://picsum.photos/seed/captain_product_' ~ product.productId ~ '/1000/700' %}
                <article class="card card--product">
                  <div class="card__media" data-bg="{{ imageUrl }}">
                    <div class="card__chips">
                      <span class="chip chip--price">{{ product.price }} DT</span>
                      <span class="chip">Stock: {{ product.stockQty }}</span>
                      <span class="chip">{{ product.isActive ? 'ACTIF' : 'INACTIF' }}</span>
                    </div>
                  </div>
                  <div class="card__body">
                    <h4 class="card__title">{{ product.name }}</h4>
                    <p class="card__desc">{{ product.description ?: 'Sans description.' }}</p>
                    <div class="card__metaRow">
                      <span class="metaPill">SKU: <b>{{ product.sku ?: '-' }}</b></span>
                      <span class="metaPill">Maj: <b>{{ product.updatedAt ? product.updatedAt|date('d/m/Y') : '-' }}</b></span>
                    </div>
                    <div class="card__actions">
                      <a class="btn btn--ghost" href="{{ path('front_product_detail', {id: product.productId}) }}">Voir detail</a>
                      <a class="btn btn--ghost" href="{{ path('front_captain_product_edit', {id: product.productId, team: active_team.teamId}) }}">Modifier</a>
                      <form method="post" action="{{ path('front_captain_product_delete', {id: product.productId}) }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('captain_product_delete_' ~ product.productId) }}">
                        <input type="hidden" name="team_id" value="{{ active_team.teamId }}">
                        <button class="btn btn--ghost" type="submit">Supprimer</button>
                      </form>
                    </div>
                  </div>
                </article>
              {% else %}
                <div class="emptyState">Aucun produit pour cette equipe.</div>
              {% endfor %}
            </div>
          </section>
        </div>
      </div>

      {% include 'front/partials/_footer.html.twig' %}
    </section>
  </main>

  {% include 'front/partials/_auth_modal.html.twig' %}
{% endblock %}

