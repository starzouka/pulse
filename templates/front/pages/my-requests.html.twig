{% extends 'base.html.twig' %}

{% block title %}PULSE - Mes demandes{% endblock %}

{% block body %}
  {% include 'front/partials/_hero_mini.html.twig' with {
    hero_kicker: 'JOUEUR',
    hero_title: 'Mes demandes',
    hero_sub: 'Historique de vos candidatures et reponses.',
    breadcrumb_current: 'Mes demandes'
  } %}

  <main class="page">
    <section class="belowHero">
      <div class="layout">
        {% include 'front/partials/_player_side_nav.html.twig' with { active: 'my_requests' } %}

        <div class="socialShell">
          <div class="socialStack">
            {% for label, messages in app.flashes %}
              {% for message in messages %}
                <div class="listItem">
                  <span>{{ message }}</span>
                  <span class="badge {{ label == 'error' ? 'badge--danger' : (label == 'info' ? 'badge--info' : 'badge--success') }}">{{ label|upper }}</span>
                </div>
              {% endfor %}
            {% endfor %}

            <section class="panel">
              <div class="panel__head">
                <h3 class="panel__title">SUIVI DES DEMANDES</h3>
                <a class="btn btn--ghost" href="{{ path('front_teams_explore') }}">Nouvelle demande</a>
              </div>

              <form class="filtersRow" method="get" action="{{ path('front_my_requests') }}" style="margin-bottom:12px;" data-auto-submit="1">
                <input class="input" type="search" name="q" value="{{ filters.q|default('') }}" placeholder="Rechercher equipe/note..." />
                <div class="select">
                  <select name="status">
                    <option value="" {{ (filters.status|default('')) == '' ? 'selected' : '' }}>Tous statuts</option>
                    <option value="PENDING" {{ (filters.status|default('')) == 'PENDING' ? 'selected' : '' }}>PENDING</option>
                    <option value="ACCEPTED" {{ (filters.status|default('')) == 'ACCEPTED' ? 'selected' : '' }}>ACCEPTED</option>
                    <option value="REFUSED" {{ (filters.status|default('')) == 'REFUSED' ? 'selected' : '' }}>REFUSED</option>
                    <option value="CANCELLED" {{ (filters.status|default('')) == 'CANCELLED' ? 'selected' : '' }}>CANCELLED</option>
                  </select>
                </div>
                <div class="select">
                  <select name="sort">
                    <option value="latest" {{ (filters.sort|default('latest')) == 'latest' ? 'selected' : '' }}>Plus recentes</option>
                    <option value="oldest" {{ (filters.sort|default('latest')) == 'oldest' ? 'selected' : '' }}>Plus anciennes</option>
                    <option value="team" {{ (filters.sort|default('latest')) == 'team' ? 'selected' : '' }}>Equipe</option>
                    <option value="status" {{ (filters.sort|default('latest')) == 'status' ? 'selected' : '' }}>Statut</option>
                  </select>
                </div>
                <button class="btn btn--ghost" type="submit">Filtrer</button>
                <a class="btn btn--ghost" href="{{ path('front_my_requests') }}">Reset</a>
              </form>

              {% if join_requests is empty %}
                <div class="emptyState">Aucune demande envoyee pour le moment.</div>
              {% else %}
                <div class="list">
                  {% for joinRequest in join_requests %}
                    {% set requestId = joinRequest.requestId ?? 0 %}
                    {% set team = joinRequest.teamId %}
                    {% set captain = joinRequest.respondedByCaptainId %}
                    {% set status = joinRequest.status|default('PENDING') %}
                    {% set badgeClass = status == 'ACCEPTED' ? 'badge--success' : (status == 'REFUSED' or status == 'CANCELLED' ? 'badge--danger' : '') %}

                    <article class="panel" style="margin-bottom:12px;">
                      <div class="postCard__head">
                        <div>
                          <div class="name">{{ team ? team.name : 'Equipe' }}</div>
                          <div class="sub">Demande envoyee le {{ joinRequest.createdAt ? joinRequest.createdAt|date('d/m/Y H:i') : '-' }}</div>
                        </div>
                        <span class="badge {{ badgeClass }}">{{ status }}</span>
                      </div>

                      {% if joinRequest.note %}
                        <div class="postCard__body">Note: {{ joinRequest.note }}</div>
                      {% endif %}

                      {% if joinRequest.respondedAt %}
                        <div class="sub" style="margin-top:6px;">
                          Reponse le {{ joinRequest.respondedAt|date('d/m/Y H:i') }}
                          {% if captain %} par {{ captain.displayName ?? captain.username }}{% endif %}
                        </div>
                      {% endif %}

                      {% if status == 'PENDING' and requestId > 0 %}
                        <div class="postCard__actions" style="margin-top:10px;">
                          <form method="post" action="{{ path('front_my_requests_cancel', {id: requestId}) }}">
                            <input type="hidden" name="_token" value="{{ csrf_token('my_request_cancel_' ~ requestId) }}">
                            <button class="btn btn--ghost" type="submit">Annuler la demande</button>
                          </form>
                        </div>
                      {% endif %}
                    </article>
                  {% endfor %}
                </div>
              {% endif %}
            </section>

            {% include 'front/partials/_pagination.html.twig' with {
              pagination: pagination,
              route_name: 'front_my_requests'
            } %}
          </div>

          <aside class="socialStack">
            <section class="panel">
              <h3 class="panel__title">STATISTIQUES</h3>
              <div class="statsRow">
                <div class="statCard"><div class="statCard__value">{{ join_requests_summary.pending|default(0) }}</div><div class="statCard__label">En attente</div></div>
                <div class="statCard"><div class="statCard__value">{{ join_requests_summary.accepted|default(0) }}</div><div class="statCard__label">Acceptees</div></div>
                <div class="statCard"><div class="statCard__value">{{ join_requests_summary.refused|default(0) }}</div><div class="statCard__label">Refusees</div></div>
              </div>
            </section>

            <section class="panel">
              <h3 class="panel__title">ACTIONS</h3>
              <div class="socialQuickList">
                <a class="listItem" href="{{ path('front_my_teams') }}"><span>Voir mes equipes</span><span class="listItem__meta">Direct</span></a>
                <a class="listItem" href="{{ path('front_notifications') }}"><span>Notifications</span><span class="listItem__meta">Alertes</span></a>
                <a class="listItem" href="{{ path('front_teams_explore') }}"><span>Chercher une equipe</span><span class="listItem__meta">Explorer</span></a>
              </div>
            </section>
          </aside>
        </div>
      </div>

      {% include 'front/partials/_footer.html.twig' %}
    </section>
  </main>

  {% include 'front/partials/_auth_modal.html.twig' %}
{% endblock %}
