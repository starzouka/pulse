{% extends 'base.html.twig' %}

{% block title %}PULSE - Detail produit{% endblock %}

{% block body %}
  {% set productId = product.productId ?? 0 %}
  {% set team = product.teamId %}
  {% set teamId = team ? (team.teamId ?? 0) : 0 %}

  {% include 'front/partials/_hero_mini.html.twig' with {
    hero_kicker: 'PRODUIT',
    hero_title: product.name,
    hero_sub: 'Fiche produit complete avec ajout panier.',
    breadcrumb_current: 'Detail produit'
  } %}

  <main class="page">
    <section class="belowHero">
      {% for label, messages in app.flashes %}
        {% for message in messages %}
          <div class="listItem">
            <span>{{ message }}</span>
            <span class="badge {{ label == 'error' ? 'badge--danger' : (label == 'info' ? 'badge--info' : 'badge--success') }}">{{ label|upper }}</span>
          </div>
        {% endfor %}
      {% endfor %}

      <div class="layout">
        <section class="panel">
          <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
            <div class="productDetailMedia">
              {% if product_images is not empty %}
                {% set firstImage = product_images|first %}
                {% set firstPath = firstImage.fileUrl ?? '' %}
                {% set firstUrl = firstPath ? (firstPath starts with 'http' ? firstPath : asset(firstPath)) : 'https://picsum.photos/seed/pulse_product_' ~ productId ~ '/700/700' %}
              {% else %}
                {% set firstUrl = 'https://picsum.photos/seed/pulse_product_' ~ productId ~ '/700/700' %}
              {% endif %}
              <div class="avatarLg" data-avatar="{{ firstUrl }}"></div>
            </div>

            <div style="flex:1; min-width:260px;">
              <h3 style="margin:0;">{{ product.name }}</h3>
              <div class="muted">
                Vendeur: {{ team ? team.name : 'Equipe' }} | Stock: {{ product.stockQty }}
              </div>
              <div class="badge badge--warning" style="margin-top:8px;">{{ product.price|number_format(2, '.', ' ') }} DT</div>

              {% if app.user %}
                <form method="post" action="{{ path('front_cart_add', {id: productId}) }}" style="margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <input type="hidden" name="_token" value="{{ csrf_token('cart_add_' ~ productId) }}">
                  <input class="input" type="number" min="1" max="{{ product.stockQty }}" name="quantity" value="1" style="max-width:100px;">
                  <button class="btn btn--primary" type="submit" {{ product.stockQty <= 0 ? 'disabled' : '' }}>
                    {{ product.stockQty <= 0 ? 'Rupture de stock' : 'Ajouter au panier' }}
                  </button>
                  <a class="btn btn--ghost" href="{{ path('front_cart') }}">Mon panier</a>
                </form>
              {% else %}
                <div style="margin-top:12px;">
                  <a class="btn btn--primary" href="{{ path('front_login', {'_target_path': login_target_path}) }}">Se connecter pour acheter</a>
                </div>
              {% endif %}

              {% if cart_quantity_for_product > 0 %}
                <div class="listItem" style="margin-top:12px;">
                  <span>Deja dans votre panier</span>
                  <span class="badge badge--info">{{ cart_quantity_for_product }}</span>
                </div>
              {% endif %}
            </div>
          </div>

          <p class="muted" style="margin-top:12px;">{{ product.description ?? 'Aucune description disponible.' }}</p>

          {% if product_images|length > 1 %}
            <div class="avatarRow" style="margin-top:12px;">
              {% for image in product_images %}
                {% set imagePath = image.fileUrl ?? '' %}
                {% set imageUrl = imagePath ? (imagePath starts with 'http' ? imagePath : asset(imagePath)) : 'https://picsum.photos/seed/pulse_product_gallery_' ~ productId ~ '_' ~ loop.index0 ~ '/300/300' %}
                <div class="avatar" data-avatar="{{ imageUrl }}"></div>
              {% endfor %}
            </div>
          {% endif %}
        </section>

        <aside class="panel">
          <h3 class="panel__title">DETAILS</h3>
          <div class="list">
            <div class="listItem"><span>SKU</span><span class="listItem__meta">{{ product.sku ?? 'N/A' }}</span></div>
            <div class="listItem"><span>Equipe vendeuse</span><span class="listItem__meta">{{ team ? team.name : '-' }}</span></div>
            <div class="listItem"><span>Statut</span><span class="listItem__meta">{{ product.isActive ? 'ACTIF' : 'INACTIF' }}</span></div>
          </div>

          <div class="panel__actions" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
            <a class="btn btn--ghost" href="{{ path('front_shop') }}">Retour boutique</a>
            {% if teamId > 0 %}
              <a class="btn btn--ghost" href="{{ path('front_team_detail', {id: teamId}) }}">Voir equipe</a>
            {% endif %}
            <a class="btn btn--ghost" href="{{ path('front_orders') }}">Mes commandes</a>
          </div>
        </aside>
      </div>

      {% if related_products is not empty %}
        <section class="panel" style="margin-top:12px;">
          <div class="panel__head">
            <div>
              <h3 class="panel__title">Produits similaires</h3>
              <div class="panel__desc">Autres produits de la meme equipe.</div>
            </div>
          </div>

          <div class="cardsGrid" style="margin-top:12px;">
            {% for related in related_products %}
              {% set relatedId = related.productId ?? 0 %}
              {% set relatedImage = related_primary_images_by_product_id[relatedId]|default(null) %}
              {% set relatedPath = relatedImage ? relatedImage.fileUrl : '' %}
              {% set relatedUrl = relatedPath ? (relatedPath starts with 'http' ? relatedPath : asset(relatedPath)) : 'https://picsum.photos/seed/pulse_related_product_' ~ relatedId ~ '/1200/800' %}

              <article class="card card--product">
                <div class="card__media" data-bg="{{ relatedUrl }}">
                  <div class="card__chips">
                    <span class="chip chip--price">{{ related.price|number_format(2, '.', ' ') }} DT</span>
                    <span class="chip">Stock: {{ related.stockQty }}</span>
                  </div>
                </div>

                <div class="card__body">
                  <h4 class="card__title">{{ related.name }}</h4>
                  <p class="card__desc">{{ related.description ? related.description|slice(0, 78) ~ (related.description|length > 78 ? '...' : '') : 'Produit de la meme equipe.' }}</p>
                  <div class="card__actions">
                    <a class="btn btn--ghost" href="{{ path('front_product_detail', {id: relatedId}) }}">Voir detail</a>
                  </div>
                </div>
              </article>
            {% endfor %}
          </div>
        </section>
      {% endif %}

      {% include 'front/partials/_footer.html.twig' %}
    </section>
  </main>

  {% include 'front/partials/_auth_modal.html.twig' %}
{% endblock %}
