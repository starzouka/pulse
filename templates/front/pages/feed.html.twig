{% extends 'base.html.twig' %}

{% block title %}PULSE - Fil d'actualite{% endblock %}

{% block body %}
  {% include 'front/partials/_hero_mini.html.twig' with {
    hero_kicker: 'JOUEUR',
    hero_title: "Fil d'actualite",
    hero_sub: 'Timeline sociale: publications, equipes et annonces.',
    breadcrumb_current: "Fil d'actualite"
  } %}

  <main class="page">
    <section class="belowHero">
      <div class="layout">
        {% include 'front/partials/_player_side_nav.html.twig' with { active: 'feed' } %}

        <div class="socialShell">
          <div class="socialStack">
            {% for label, messages in app.flashes %}
              {% for message in messages %}
                <div class="listItem">
                  <span>{{ message }}</span>
                  <span class="badge {{ label == 'error' ? 'badge--danger' : (label == 'info' ? 'badge--info' : 'badge--success') }}">{{ label|upper }}</span>
                </div>
              {% endfor %}
            {% endfor %}

            {% if viewer_user %}
              {% include 'front/partials/_post_composer.html.twig' with {
                viewer_user: viewer_user,
                action_route: 'front_feed_post_create',
                csrf_token_id: 'feed_post_create',
                placeholder: "Que voulez-vous partager aujourd'hui ?",
                form_class: 'panel gadget gadget--composer'
              } %}
            {% else %}
              <section class="panel gadget">
                <div class="emptyState">
                  Connectez-vous pour publier et interagir avec le fil.
                  <div style="margin-top:10px;"><a class="btn btn--primary" href="{{ path('front_login', {'_target_path': app.request.uri}) }}">Se connecter</a></div>
                </div>
              </section>
            {% endif %}

            <section class="panel gadget">
              <div class="panel__head">
                <h3 class="panel__title">NOUVEAUTES</h3>
                <div class="panel__desc">{{ feed_posts|length }} publication(s)</div>
              </div>

              <form class="filtersRow" method="get" action="{{ path('front_feed') }}" style="margin-bottom:12px;">
                <input class="input" type="search" name="q" value="{{ filters.q|default('') }}" placeholder="Rechercher auteur, texte..." />
                <div class="select">
                  <select name="visibility">
                    <option value="" {{ (filters.visibility|default('')) == '' ? 'selected' : '' }}>Toutes visibilites</option>
                    <option value="PUBLIC" {{ (filters.visibility|default('')) == 'PUBLIC' ? 'selected' : '' }}>PUBLIC</option>
                    <option value="FRIENDS" {{ (filters.visibility|default('')) == 'FRIENDS' ? 'selected' : '' }}>FRIENDS</option>
                    <option value="TEAM_ONLY" {{ (filters.visibility|default('')) == 'TEAM_ONLY' ? 'selected' : '' }}>TEAM_ONLY</option>
                  </select>
                </div>
                {% if viewer_user %}
                  <div class="select">
                    <select name="author">
                      <option value="" {{ (filters.author|default('')) == '' ? 'selected' : '' }}>Tous les auteurs</option>
                      <option value="me" {{ (filters.author|default('')) == 'me' ? 'selected' : '' }}>Mes posts</option>
                    </select>
                  </div>
                {% endif %}
                <div class="select">
                  <select name="sort">
                    <option value="latest" {{ (filters.sort|default('latest')) == 'latest' ? 'selected' : '' }}>Plus recents</option>
                    <option value="oldest" {{ (filters.sort|default('latest')) == 'oldest' ? 'selected' : '' }}>Plus anciens</option>
                    <option value="liked" {{ (filters.sort|default('latest')) == 'liked' ? 'selected' : '' }}>Plus likes</option>
                    <option value="commented" {{ (filters.sort|default('latest')) == 'commented' ? 'selected' : '' }}>Plus commentes</option>
                  </select>
                </div>
                <button class="btn btn--ghost" type="submit">Filtrer</button>
                <a class="btn btn--ghost" href="{{ path('front_feed') }}">Reset</a>
              </form>

              <div
                id="feedContainer"
                data-infinite-feed
                data-feed-endpoint="{{ path('front_feed_chunk') }}"
                data-feed-query="{{ feed_query_string|default('') }}"
                data-feed-limit="{{ feed_limit|default(12) }}"
                data-feed-offset="{{ feed_posts|length }}"
                data-feed-has-more="{{ feed_has_more|default(false) ? '1' : '0' }}"
              >
                {% for postData in feed_posts %}
                  {% include 'front/partials/_post_card.html.twig' with {
                    post_data: postData,
                    viewer_user: viewer_user,
                    like_route: 'front_feed_post_like',
                    comment_route: 'front_feed_post_comment',
                    report_route: 'front_feed_post_report',
                    like_token_prefix: 'feed_post_like_',
                    comment_token_prefix: 'feed_post_comment_',
                    report_token_prefix: 'feed_post_report_'
                  } %}
                {% endfor %}
              </div>

              {% if feed_posts is empty %}
                <div class="emptyState" data-feed-empty>Aucune publication disponible.</div>
              {% endif %}

              <div class="emptyState" data-feed-loader hidden>Chargement...</div>
              <div class="emptyState" data-feed-end {{ feed_has_more|default(false) ? 'hidden' : '' }}>Fin du fil.</div>
              <div data-feed-sentinel></div>
            </section>
          </div>

          <aside class="socialStack">
            <section class="panel gadget">
              <h3 class="panel__title">TENDANCES</h3>
              <div class="socialQuickList">
                <a class="listItem" href="{{ path('front_tournaments') }}"><span>#PulseInvitational</span><span class="listItem__meta">Tournois</span></a>
                <a class="listItem" href="{{ path('front_games') }}"><span>#Valorant</span><span class="listItem__meta">Jeux</span></a>
                <a class="listItem" href="{{ path('front_teams') }}"><span>#NorthHydra</span><span class="listItem__meta">Equipes</span></a>
              </div>
            </section>

            <section class="panel gadget gadget--alert">
              <h3 class="panel__title">RACCOURCIS</h3>
              <div class="socialQuickList">
                <a class="listItem" href="{{ path('front_notifications') }}"><span>Notifications</span><span class="listItem__meta">Alertes</span></a>
                <a class="listItem" href="{{ path('front_messages') }}"><span>Messagerie</span><span class="listItem__meta">Direct</span></a>
                <a class="listItem" href="{{ path('front_profile', {tab: 'posts'}) }}"><span>Mon profil</span><span class="listItem__meta">Posts</span></a>
              </div>
            </section>
          </aside>
        </div>
      </div>

      {% include 'front/partials/_footer.html.twig' %}
    </section>
  </main>

  {% include 'front/partials/_auth_modal.html.twig' %}
{% endblock %}
